# Task 5.2 - Command Implementations

## Quick Reference

| Item | Status | Notes |
|------|--------|-------|
| Command.h base class | ✅ EXISTS | `include/model/Command.h` |
| CommandHistory | ✅ EXISTS | `include/model/CommandHistory.h` |
| GeometryMath::translate() | ✅ EXISTS | All entity types supported |
| GeometryMath::rotate() | ✅ EXISTS | All entity types supported |
| GeometryMath::mirror() | ❌ MISSING | Needs implementation |
| DocumentModel::restoreEntity() | ❌ MISSING | Needs implementation |
| EntityCommands | ❌ MISSING | Main deliverable of this task |

**First Action:** Start with Step A1 (add `restoreEntity()` to DocumentModel)

---

## Overview

Implement concrete Command classes for all undoable operations. These commands capture the state needed for undo/redo and interact with DocumentModel to execute operations.

**Dependencies:**
- Task 5.1 (Command Pattern Architecture) - COMPLETE
  - `Command` base class exists (`include/model/Command.h`)
  - `CommandHistory` exists (`include/model/CommandHistory.h`)

**Prerequisite Knowledge:**
- Command interface: `execute()`, `undo()`, `redo()`, `description()`
- DocumentModel API: `addLine()`, `addArc()`, `removeEntity()`, `updateEntity()`, `findEntityByHandle()`
- GeometryEntity variant: `std::variant<Line2D, Arc2D, Ellipse2D, Point2D>`

---

## Objectives

- [x] Create `CreateEntityCommand` (add Line/Arc/Ellipse/Point)
- [x] Create `DeleteEntityCommand` (remove single entity)
- [x] Create `DeleteEntitiesCommand` (remove multiple entities)
- [x] Create `MoveEntitiesCommand` (translate selection)
- [x] Create `RotateEntitiesCommand` (rotate selection)
- [x] Create `MirrorEntitiesCommand` (mirror selection)
- [ ] Wire tools (LineTool, ArcTool, MoveTool, RotateTool) to create commands
- [ ] Unit tests for all command implementations

---

## Architecture

### Command Hierarchy

```
Command (abstract)
    │
    ├── CreateEntityCommand      - Creates single entity (Line/Arc/etc)
    │
    ├── DeleteEntityCommand      - Deletes single entity
    │
    ├── DeleteEntitiesCommand    - Deletes multiple entities (bulk)
    │
    ├── MoveEntitiesCommand      - Translates multiple entities
    │
    ├── RotateEntitiesCommand    - Rotates multiple entities around center
    │
    └── MirrorEntitiesCommand    - Mirrors multiple entities across axis
```

### State Storage Pattern

Each command stores:
1. **Input state** - What the user specified (handles, parameters)
2. **Undo state** - What's needed to reverse (original geometry, generated handles)

```
┌─────────────────────────────────────────────────────────────────┐
│ CreateEntityCommand                                              │
├─────────────────────────────────────────────────────────────────┤
│ Input:  GeometryEntity entity, std::string layer                 │
│ Undo:   std::string generatedHandle (to remove on undo)          │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ DeleteEntityCommand                                              │
├─────────────────────────────────────────────────────────────────┤
│ Input:  std::string handle                                       │
│ Undo:   GeometryEntityWithMetadata savedEntity (full copy)       │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ MoveEntitiesCommand                                              │
├─────────────────────────────────────────────────────────────────┤
│ Input:  std::vector<std::string> handles, double dx, double dy   │
│ Undo:   Reverse: apply -dx, -dy (no geometry copy needed)        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ RotateEntitiesCommand                                            │
├─────────────────────────────────────────────────────────────────┤
│ Input:  handles, Point2D center, double angleRadians             │
│ Undo:   Reverse: rotate by -angleRadians around same center      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│ MirrorEntitiesCommand                                            │
├─────────────────────────────────────────────────────────────────┤
│ Input:  handles, Point2D axisP1, Point2D axisP2, bool keepOrig   │
│ Undo:   If keepOriginal: delete new entities                     │
│         If !keepOriginal: restore original geometry              │
└─────────────────────────────────────────────────────────────────┘
```

---

## File Locations

### New Files to Create

| File | Location | Responsibility |
|------|----------|----------------|
| `EntityCommands.h` | `include/model/` | All entity command class declarations |
| `EntityCommands.cpp` | `src/model/` | All entity command implementations |

**Design Decision:** Single file pair for all entity commands to:
- Reduce file proliferation
- Keep related commands together
- Simplify includes

### Files to Modify

| File | Changes |
|------|---------|
| `CMakeLists.txt` | Add `src/model/EntityCommands.cpp` |
| `DocumentModel.h` | Add `restoreEntity()` method for undo |
| `DocumentModel.cpp` | Implement `restoreEntity()` |
| `LineTool.cpp` | Create `CreateEntityCommand` instead of direct `addLine()` |
| `ArcTool.cpp` | Create `CreateEntityCommand` instead of direct `addArc()` |
| `RectangleTool.cpp` | Create multiple `CreateEntityCommand` or composite |
| `MoveTool.cpp` | Create `MoveEntitiesCommand` on commit |
| `RotateTool.cpp` | Create `RotateEntitiesCommand` on commit |

---

## Implementation Details

### 1. CreateEntityCommand

**Purpose:** Add a single entity (Line2D, Arc2D, Ellipse2D, or Point2D) to the document.

```cpp
class CreateEntityCommand : public Command {
public:
    /**
     * @brief Construct create command
     * @param model Target document
     * @param entity Geometry to add (variant)
     * @param layer Target layer name
     */
    CreateEntityCommand(DocumentModel* model,
                        const Import::GeometryEntity& entity,
                        const std::string& layer = "0");

    bool execute() override;
    bool undo() override;
    QString description() const override;

private:
    Import::GeometryEntity m_entity;
    std::string m_layer;
    std::string m_generatedHandle;  // Set by execute(), used by undo()
};
```

**Execute Logic:**
1. Visit variant to determine type (Line2D, Arc2D, etc.)
2. Call appropriate `DocumentModel::addLine()` or `addArc()`
3. Store returned handle in `m_generatedHandle`
4. Return success

**Undo Logic:**
1. Call `DocumentModel::removeEntity(m_generatedHandle)`
2. Return success

**Redo Logic:**
- Default `redo()` calls `execute()` - but handle will change!
- Need custom `redo()` that re-adds with potentially different handle
- OR: Store the entity and re-add, accept new handle

**Description:**
- Line: `"Draw Line"`
- Arc: `"Draw Arc"`
- Circle (full arc): `"Draw Circle"`
- Point: `"Draw Point"`

---

### 2. DeleteEntityCommand (Single)

**Purpose:** Remove a single entity from the document with full undo support.

```cpp
class DeleteEntityCommand : public Command {
public:
    /**
     * @brief Construct delete command
     * @param model Target document
     * @param handle Entity handle to delete
     */
    DeleteEntityCommand(DocumentModel* model, const std::string& handle);

    bool execute() override;
    bool undo() override;
    QString description() const override;
    bool isValid() const override;

private:
    std::string m_handle;
    std::optional<Import::GeometryEntityWithMetadata> m_savedEntity;
};
```

**Execute Logic:**
1. Find entity by handle
2. If not found, return false
3. Copy full `GeometryEntityWithMetadata` to `m_savedEntity`
4. Call `DocumentModel::removeEntity(m_handle)`
5. Return success

**Undo Logic:**
1. Restore entity using saved copy
2. Need `DocumentModel::restoreEntity(GeometryEntityWithMetadata)` method
3. Return success

**isValid:**
- Check handle is not empty
- Check entity exists in document

**Description:** `"Delete [type]"` (e.g., "Delete Line")

---

### 3. DeleteEntitiesCommand (Multiple)

**Purpose:** Remove multiple entities at once (e.g., from selection).

```cpp
class DeleteEntitiesCommand : public Command {
public:
    /**
     * @brief Construct bulk delete command
     * @param model Target document
     * @param handles Entity handles to delete
     */
    DeleteEntitiesCommand(DocumentModel* model,
                          const std::vector<std::string>& handles);

    bool execute() override;
    bool undo() override;
    QString description() const override;
    bool isValid() const override;

private:
    std::vector<std::string> m_handles;
    std::vector<Import::GeometryEntityWithMetadata> m_savedEntities;
};
```

**Execute Logic:**
1. For each handle:
   - Find entity, save copy to `m_savedEntities`
   - Remove from document
2. Clear any that weren't found
3. Return true if at least one deleted

**Undo Logic:**
1. Restore all saved entities (reverse order for consistency)
2. Return success

**Description:** `"Delete N entities"` where N = count

---

### 4. MoveEntitiesCommand

**Purpose:** Translate entities by (dx, dy).

```cpp
class MoveEntitiesCommand : public Command {
public:
    /**
     * @brief Construct move command
     * @param model Target document
     * @param handles Entity handles to move
     * @param dx X translation (world units)
     * @param dy Y translation (world units)
     */
    MoveEntitiesCommand(DocumentModel* model,
                        const std::vector<std::string>& handles,
                        double dx, double dy);

    bool execute() override;
    bool undo() override;
    QString description() const override;
    bool isValid() const override;

    // For command merging (rapid drag updates)
    bool canMerge(const Command* other) const override;
    bool merge(const Command* other) override;

private:
    std::vector<std::string> m_handles;
    double m_dx;
    double m_dy;

    // Helper: apply translation to all entities
    bool applyTranslation(double dx, double dy);
};
```

**Execute Logic:**
1. For each handle:
   - Find entity
   - Apply translation using `GeometryMath::translate()`
   - Update document via `updateEntity()`
2. Return true if all succeeded

**Undo Logic:**
1. Apply reverse translation: `applyTranslation(-m_dx, -m_dy)`

**Translation Implementation:**
```cpp
// For Line2D:
Geometry::Line2D translated = GeometryMath::translate(line, dx, dy);

// For Arc2D:
Geometry::Arc2D translated = GeometryMath::translate(arc, dx, dy);

// Update in document:
m_documentModel->updateEntity(handle, Import::GeometryEntity{translated});
```

**Command Merging:**
- `canMerge()`: Check if same entity set and within time threshold (e.g., 500ms)
- `merge()`: Accumulate dx/dy values

**Description:**
- Single entity: `"Move entity"`
- Multiple: `"Move N entities"`

---

### 5. RotateEntitiesCommand

**Purpose:** Rotate entities around a center point by an angle.

```cpp
class RotateEntitiesCommand : public Command {
public:
    /**
     * @brief Construct rotate command
     * @param model Target document
     * @param handles Entity handles to rotate
     * @param center Rotation center point
     * @param angleRadians Rotation angle (positive = CCW)
     */
    RotateEntitiesCommand(DocumentModel* model,
                          const std::vector<std::string>& handles,
                          const Geometry::Point2D& center,
                          double angleRadians);

    bool execute() override;
    bool undo() override;
    QString description() const override;
    bool isValid() const override;

private:
    std::vector<std::string> m_handles;
    Geometry::Point2D m_center;
    double m_angleRadians;

    // Helper: apply rotation to all entities
    bool applyRotation(double angleRadians);
};
```

**Execute Logic:**
1. For each handle:
   - Find entity
   - Apply rotation using `GeometryMath::rotate(entity, center, angle)`
   - Update document
2. Return true if all succeeded

**Undo Logic:**
1. Apply reverse rotation: `applyRotation(-m_angleRadians)`

**CRITICAL - Arc Direction Preservation:**
```cpp
// When rotating Arc2D, direction (CCW/CW) must be preserved
// GeometryMath::rotate() must NOT flip direction
// This is critical for CNC toolpath generation
```

**Description:**
- `"Rotate N entities by X°"` where X = degrees (converted from radians)

---

### 6. MirrorEntitiesCommand

**Purpose:** Mirror entities across an axis defined by two points.

```cpp
class MirrorEntitiesCommand : public Command {
public:
    /**
     * @brief Construct mirror command
     * @param model Target document
     * @param handles Entity handles to mirror
     * @param axisPoint1 First point defining mirror axis
     * @param axisPoint2 Second point defining mirror axis
     * @param keepOriginal If true, create copies; if false, replace originals
     */
    MirrorEntitiesCommand(DocumentModel* model,
                          const std::vector<std::string>& handles,
                          const Geometry::Point2D& axisPoint1,
                          const Geometry::Point2D& axisPoint2,
                          bool keepOriginal = false);

    bool execute() override;
    bool undo() override;
    QString description() const override;
    bool isValid() const override;

private:
    std::vector<std::string> m_handles;
    Geometry::Point2D m_axisPoint1;
    Geometry::Point2D m_axisPoint2;
    bool m_keepOriginal;

    // For undo:
    std::vector<std::string> m_createdHandles;  // If keepOriginal
    std::vector<Import::GeometryEntityWithMetadata> m_originalEntities;  // If !keepOriginal
};
```

**Execute Logic (keepOriginal = true):**
1. For each handle:
   - Find entity
   - Create mirrored copy using `GeometryMath::mirror()`
   - Add new entity to document
   - Store new handle in `m_createdHandles`

**Execute Logic (keepOriginal = false):**
1. For each handle:
   - Find entity, save copy to `m_originalEntities`
   - Create mirrored geometry
   - Update entity in document

**Undo Logic (keepOriginal = true):**
1. Remove all created handles

**Undo Logic (keepOriginal = false):**
1. Restore original entities from `m_originalEntities`

**CRITICAL - Arc Direction Handling:**
```cpp
// Mirroring INVERTS arc direction!
// CCW arc mirrored across X-axis becomes CW arc
// This must be handled correctly in GeometryMath::mirror()
```

**Description:**
- `"Mirror N entities"` or `"Mirror and copy N entities"`

---

## DocumentModel Additions

Add this method to support undo of delete operations:

```cpp
// In DocumentModel.h:

/**
 * @brief Restore a previously deleted entity
 * @param entity Full entity with metadata (handle, layer, etc.)
 * @return true if restored successfully
 *
 * Note: Reuses the original handle. If handle conflicts exist,
 * returns false (indicates corruption or bug).
 */
bool restoreEntity(const Import::GeometryEntityWithMetadata& entity);
```

```cpp
// In DocumentModel.cpp:

bool DocumentModel::restoreEntity(const Import::GeometryEntityWithMetadata& entity)
{
    // Check for handle conflict
    if (findEntityByHandle(entity.handle) != nullptr) {
        qWarning() << "DocumentModel::restoreEntity: handle conflict:"
                   << QString::fromStdString(entity.handle);
        return false;
    }

    // Add to entity list
    entities_.push_back(entity);

    // Recalculate statistics (optional - could defer)
    calculateStatistics();

    return true;
}
```

---

## GeometryMath Status

### Already Implemented (GeometryMath.h:250-341) ✅

```cpp
// Translation - ALL EXIST
Point2D translate(const Point2D& point, double dx, double dy);
std::optional<Line2D> translate(const Line2D& line, double dx, double dy);
std::optional<Arc2D> translate(const Arc2D& arc, double dx, double dy);
std::optional<Ellipse2D> translate(const Ellipse2D& ellipse, double dx, double dy);

// Rotation - ALL EXIST
Point2D rotate(const Point2D& point, const Point2D& center, double angleRadians);
std::optional<Line2D> rotate(const Line2D& line, const Point2D& center, double angleRadians);
std::optional<Arc2D> rotate(const Arc2D& arc, const Point2D& center, double angleRadians);
std::optional<Ellipse2D> rotate(const Ellipse2D& ellipse, const Point2D& center, double angleRadians);

// Angle snapping - EXISTS
double snapAngle(double angleRadians, double snapIncrement);
```

### Needs Implementation (for MirrorEntitiesCommand) ❌

```cpp
// Mirror functions - MUST BE ADDED to GeometryMath.h/cpp

/**
 * @brief Mirror a point across an axis defined by two points
 * @param point Point to mirror
 * @param axisP1 First point on mirror axis
 * @param axisP2 Second point on mirror axis
 * @return Mirrored point
 */
Point2D mirror(const Point2D& point, const Point2D& axisP1, const Point2D& axisP2) noexcept;

/**
 * @brief Mirror a line across an axis
 * @return Mirrored line (endpoints swapped to maintain direction sense)
 */
std::optional<Line2D> mirror(const Line2D& line, const Point2D& axisP1, const Point2D& axisP2) noexcept;

/**
 * @brief Mirror an arc across an axis
 * @return Mirrored arc with INVERTED direction (CCW becomes CW, CW becomes CCW)
 *
 * CRITICAL: Direction inversion is mathematically required and important for CNC toolpaths.
 */
std::optional<Arc2D> mirror(const Arc2D& arc, const Point2D& axisP1, const Point2D& axisP2) noexcept;

/**
 * @brief Mirror an ellipse across an axis
 * @return Mirrored ellipse with adjusted rotation and direction
 */
std::optional<Ellipse2D> mirror(const Ellipse2D& ellipse, const Point2D& axisP1, const Point2D& axisP2) noexcept;
```

### Mirror Implementation Algorithm

```cpp
// Mirror point across axis:
// 1. Translate axis to origin (subtract axisP1)
// 2. Rotate to align axis with X-axis
// 3. Reflect Y coordinate (y = -y)
// 4. Rotate back
// 5. Translate back

Point2D mirror(const Point2D& point, const Point2D& axisP1, const Point2D& axisP2) noexcept
{
    // Axis direction vector
    double dx = axisP2.x() - axisP1.x();
    double dy = axisP2.y() - axisP1.y();
    double len = std::sqrt(dx*dx + dy*dy);

    if (len < GEOMETRY_EPSILON) {
        return point;  // Degenerate axis, return unchanged
    }

    // Normalize
    dx /= len;
    dy /= len;

    // Translate point relative to axisP1
    double px = point.x() - axisP1.x();
    double py = point.y() - axisP1.y();

    // Project onto axis and perpendicular
    double proj = px * dx + py * dy;  // Along axis
    double perp = px * dy - py * dx;  // Perpendicular (signed distance)

    // Reflect: negate perpendicular component
    // Reconstruct point: axisP1 + proj * axis_dir - perp * perp_dir
    double mx = axisP1.x() + proj * dx - perp * dy;
    double my = axisP1.y() + proj * dy + perp * dx;

    return Point2D(mx, my);
}
```

---

## Tool Integration

### LineTool Integration

```cpp
// In LineTool::commitLine() (or equivalent):

void LineTool::commitLine()
{
    auto lineOpt = Geometry::Line2D::create(m_firstPoint, m_secondPoint);
    if (!lineOpt) {
        emit statusUpdate("Invalid line (zero length)");
        return;
    }

    // Create command instead of direct add
    auto command = std::make_unique<CreateEntityCommand>(
        m_documentModel,
        Import::GeometryEntity{*lineOpt},
        "0"  // layer
    );

    // Execute via CommandHistory
    m_commandHistory->executeCommand(std::move(command));

    // Reset tool state
    m_state = WaitingFirstPoint;
    emit toolCompleted();
}
```

### MoveTool Integration

```cpp
// In MoveTool::commitMove():

void MoveTool::commitMove()
{
    double dx = m_destination.x() - m_basePoint.x();
    double dy = m_destination.y() - m_basePoint.y();

    auto command = std::make_unique<MoveEntitiesCommand>(
        m_documentModel,
        m_selectedHandles,  // std::vector<std::string>
        dx, dy
    );

    m_commandHistory->executeCommand(std::move(command));

    // Reset
    deactivate();
}
```

---

## Implementation Steps

### Phase A: Core Commands (No Tool Wiring)

#### Step A1: Add DocumentModel::restoreEntity()

1. Add declaration to `include/model/DocumentModel.h`
2. Add implementation to `src/model/DocumentModel.cpp`
3. Unit test: delete entity → restore entity → verify identical

**Files Modified:** `DocumentModel.h`, `DocumentModel.cpp`

#### Step A2: Create EntityCommands Header

Create `include/model/EntityCommands.h`:
1. Include guards, necessary headers
2. Declare `CreateEntityCommand` class
3. Declare `DeleteEntityCommand` class
4. Declare `DeleteEntitiesCommand` class
5. Declare `MoveEntitiesCommand` class
6. Declare `RotateEntitiesCommand` class
7. Declare `MirrorEntitiesCommand` class (stub, needs mirror functions)

**Files Created:** `EntityCommands.h`

#### Step A3: Implement Core Commands

Create `src/model/EntityCommands.cpp`:
1. Implement `CreateEntityCommand` (execute/undo/redo/description)
2. Implement `DeleteEntityCommand`
3. Implement `DeleteEntitiesCommand`
4. Implement `MoveEntitiesCommand` (uses existing GeometryMath::translate)
5. Implement `RotateEntitiesCommand` (uses existing GeometryMath::rotate)

**Files Created:** `EntityCommands.cpp`

#### Step A4: Update Build System

Add to `CMakeLists.txt`:
```cmake
# In source files:
src/model/EntityCommands.cpp

# In header files:
include/model/EntityCommands.h
```

**Files Modified:** `CMakeLists.txt`

#### Step A5: Unit Tests for Commands

Create `tests/model/test_EntityCommands.cpp`:
- Test each command in isolation
- Test execute/undo/redo cycles
- Test edge cases (empty selection, invalid handles)

**Files Created:** `test_EntityCommands.cpp`

---

### Phase B: Mirror Function Implementation

#### Step B1: Add Mirror Functions to GeometryMath

Add to `include/geometry/GeometryMath.h`:
- `mirror(Point2D, ...)` declaration
- `mirror(Line2D, ...)` declaration
- `mirror(Arc2D, ...)` declaration
- `mirror(Ellipse2D, ...)` declaration

Add to `src/geometry/GeometryMath.cpp`:
- All mirror implementations
- Arc direction inversion logic

**Files Modified:** `GeometryMath.h`, `GeometryMath.cpp`

#### Step B2: Test Mirror Functions

Add tests to `tests/geometry/test_GeometryMath.cpp`:
- Mirror point over X-axis
- Mirror point over Y-axis
- Mirror point over arbitrary axis
- Mirror arc verifies direction inversion

**Files Modified:** `test_GeometryMath.cpp`

#### Step B3: Complete MirrorEntitiesCommand

Finish implementation in `EntityCommands.cpp`:
- Full execute/undo/redo logic
- keepOriginal vs replace logic

**Files Modified:** `EntityCommands.cpp`

---

### Phase C: Tool Integration

#### Step C1: Wire LineTool

1. Add `CommandHistory*` member to `LineTool`
2. Add `setCommandHistory()` method or constructor parameter
3. Modify `commitLine()` to create and execute command
4. Update `ToolManager` to pass CommandHistory to tools

**Files Modified:** `LineTool.h`, `LineTool.cpp`, `ToolManager.cpp`

**Test:** Draw line → Ctrl+Z → Line disappears → Ctrl+Y → Line returns

#### Step C2: Wire ArcTool

Same pattern as LineTool.

**Files Modified:** `ArcTool.h`, `ArcTool.cpp`

#### Step C3: Wire RectangleTool

**Option A (Simple):** Create 4 separate `CreateEntityCommand`
- Pro: Simple implementation
- Con: 4 undo steps for one rectangle

**Option B (Recommended):** Create `CreateEntitiesCommand` for batch
- Pro: Single undo step
- Con: Need new command class

Decision: **Option B** - Add `CreateEntitiesCommand` to `EntityCommands.h/cpp`

**Files Modified:** `EntityCommands.h`, `EntityCommands.cpp`, `RectangleTool.cpp`

#### Step C4: Wire MoveTool

1. Add `CommandHistory*` member
2. Modify commit to create `MoveEntitiesCommand`
3. Remove direct geometry modification from tool

**Files Modified:** `MoveTool.h`, `MoveTool.cpp`

**Test:** Move → Ctrl+Z → Entities return to original position

#### Step C5: Wire RotateTool

Same pattern as MoveTool.

**Files Modified:** `RotateTool.h`, `RotateTool.cpp`

#### Step C6: Integration Test

Full integration test:
1. Draw line → Ctrl+Z → Ctrl+Y
2. Draw arc → Ctrl+Z → Ctrl+Y
3. Select → Move → Ctrl+Z
4. Select → Rotate → Ctrl+Z
5. Multiple operations → Multiple Ctrl+Z
6. Verify Edit menu shows correct descriptions

---

### Recommended Execution Order

```
A1 → A2 → A3 → A4 → A5 (Core commands testable without UI)
     ↓
     B1 → B2 → B3 (Mirror support, can be deferred)
     ↓
     C1 → C2 → C3 → C4 → C5 → C6 (Tool wiring, user-visible)
```

**Minimum Viable Implementation:**
- A1 through A4 + C1 gives you undo/redo for line drawing
- This can be tested immediately with Ctrl+Z/Ctrl+Y

---

## Testing Strategy

### Unit Tests (`tests/model/test_EntityCommands.cpp`)

```cpp
// CreateEntityCommand tests
TEST(CreateEntityCommand, ExecuteAddsLineToDocument)
TEST(CreateEntityCommand, UndoRemovesLine)
TEST(CreateEntityCommand, RedoAddsLineBack)
TEST(CreateEntityCommand, InvalidLineRejected)
TEST(CreateEntityCommand, DescriptionIsCorrect)

// DeleteEntityCommand tests
TEST(DeleteEntityCommand, ExecuteRemovesEntity)
TEST(DeleteEntityCommand, UndoRestoresEntity)
TEST(DeleteEntityCommand, NonexistentHandleFails)
TEST(DeleteEntityCommand, PreservesMetadata)

// MoveEntitiesCommand tests
TEST(MoveEntitiesCommand, ExecuteTranslatesAllEntities)
TEST(MoveEntitiesCommand, UndoReversesTranslation)
TEST(MoveEntitiesCommand, ZeroMoveIsValid)
TEST(MoveEntitiesCommand, MergeAccumulatesDelta)

// RotateEntitiesCommand tests
TEST(RotateEntitiesCommand, ExecuteRotatesAllEntities)
TEST(RotateEntitiesCommand, UndoReversesRotation)
TEST(RotateEntitiesCommand, 360DegreeRotationIsIdentity)
TEST(RotateEntitiesCommand, ArcDirectionPreserved)

// MirrorEntitiesCommand tests
TEST(MirrorEntitiesCommand, MirrorOverXAxis)
TEST(MirrorEntitiesCommand, MirrorOverYAxis)
TEST(MirrorEntitiesCommand, MirrorOverCustomAxis)
TEST(MirrorEntitiesCommand, KeepOriginalCreatesCopies)
TEST(MirrorEntitiesCommand, ArcDirectionInverted)
```

### Integration Tests

```cpp
// Full cycle: Draw → Undo → Redo → Delete → Undo
TEST(UndoRedoIntegration, DrawLineUndoRedoDeleteUndo)
{
    // 1. Draw line
    // 2. Verify exists
    // 3. Undo
    // 4. Verify removed
    // 5. Redo
    // 6. Verify exists
    // 7. Delete
    // 8. Verify removed
    // 9. Undo
    // 10. Verify exists
}
```

### Manual Testing Checklist

- [ ] Draw line → Ctrl+Z removes it → Ctrl+Y restores it
- [ ] Draw arc → Ctrl+Z removes it → Ctrl+Y restores it
- [ ] Draw rectangle → Single Ctrl+Z removes all 4 lines (if using batch command)
- [ ] Select entities → Move → Ctrl+Z returns to original position
- [ ] Select entities → Rotate → Ctrl+Z returns to original angle
- [ ] Multiple operations → Multiple Ctrl+Z in sequence
- [ ] Undo → New operation → Redo stack cleared

---

## Edge Cases

### Handle Regeneration on Redo

When `CreateEntityCommand::redo()` is called, the document may assign a different handle than the original. This is acceptable because:
1. Handle is internal identifier, not user-visible
2. Command stores new handle for subsequent undo
3. Selection should be cleared on undo anyway

### Empty Selection

Commands with empty handle lists should:
- `isValid()` returns false
- `execute()` returns false immediately
- No state changes

### Partial Failure

If some entities in a bulk operation fail:
- Option A: Fail entire command (rollback)
- Option B: Succeed with subset (log warnings)

Recommendation: Option A for data integrity. CAD operations should be atomic.

### Geometry Validation After Transform

After move/rotate, geometry should remain valid:
- Lines should not become zero-length
- Arcs should not become zero-radius
- If transform would create invalid geometry, command should fail

---

## Notes

### Why No ScaleCommand?

Scale is not in Phase 1 scope. When added:
- Similar to RotateEntitiesCommand
- Must handle non-uniform scale (anisotropic)
- Arcs become ellipses under non-uniform scale (complex!)

### Thread Safety

All commands are designed for UI thread only:
- DocumentModel is not thread-safe
- CommandHistory is not thread-safe
- No locking needed if this constraint is maintained

### Memory Considerations

Commands store state for undo:
- Delete commands store full entity copies
- With 100-command limit, this is bounded
- Large selections could use significant memory
- Consider compressing or lazy-loading for very large selections (future)

---

## Summary

| Command | Stores for Undo | Key Complexity |
|---------|-----------------|----------------|
| CreateEntity | Generated handle | Handle may change on redo |
| DeleteEntity | Full entity copy | Must preserve all metadata |
| DeleteEntities | Vector of copies | Order matters for restore |
| MoveEntities | dx, dy values | Reversible by negation |
| RotateEntities | center, angle | Reversible by negation |
| MirrorEntities | Original copies OR created handles | Depends on keepOriginal flag |

---

END OF TASK 5.2
