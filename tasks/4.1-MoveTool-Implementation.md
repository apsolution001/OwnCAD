# Task 4.1 - Move Tool Implementation Guide

## Overview

The Move Tool allows users to translate selected entities by a displacement vector.
This is the first transformation tool and establishes patterns for Rotate/Mirror tools.

**Workflow:**
1. User selects entities (using existing selection system)
2. User activates Move Tool
3. User clicks base point (snap-aware)
4. User moves mouse → preview shows entities at new position
5. User clicks destination OR enters dx,dy values → commit move
6. Tool returns to selection mode

---

## Subtasks Breakdown

### 4.1.1 Extend DocumentModel for Entity Modification
**Priority: PREREQUISITE**

DocumentModel currently only supports `addLine()` and `addArc()`.
For Move (and future Rotate/Mirror), we need entity modification.

**New Methods Required:**
```cpp
// Find entity by handle
GeometryEntityWithMetadata* findEntityByHandle(const std::string& handle);
const GeometryEntityWithMetadata* findEntityByHandle(const std::string& handle) const;

// Replace entity geometry (preserves metadata)
bool updateEntity(const std::string& handle, const GeometryEntity& newGeometry);

// Delete entity (for future use)
bool removeEntity(const std::string& handle);
```

**Files to Modify:**
- `include/model/DocumentModel.h` - Add method declarations
- `src/model/DocumentModel.cpp` - Implement methods

**Implementation Notes:**
- `findEntityByHandle`: Linear search is acceptable for now (O(n))
- `updateEntity`: Replaces the geometry variant while preserving layer/handle/color
- Rerun validation after modification

---

### 4.1.2 Add Geometry Translation Functions
**Priority: PREREQUISITE**

Need pure functions to translate geometry by a displacement vector.

**Location:** `include/geometry/GeometryMath.h` / `src/geometry/GeometryMath.cpp`

**New Functions:**
```cpp
// Translate a point by displacement
Point2D translate(const Point2D& point, double dx, double dy);

// Translate a line by displacement
Line2D translate(const Line2D& line, double dx, double dy);

// Translate an arc by displacement (center moves, angles preserved)
Arc2D translate(const Arc2D& arc, double dx, double dy);

// Translate an ellipse by displacement (center moves, angles preserved)
Ellipse2D translate(const Ellipse2D& ellipse, double dx, double dy);

// Generic translate for variant
GeometryEntity translate(const GeometryEntity& entity, double dx, double dy);
```

**Critical Notes:**
- Arc/Ellipse translation ONLY moves the center - radii and angles are preserved
- Line translation moves both endpoints
- All functions return NEW geometry (immutability preserved)
- Validate output (ensure no degenerate geometry after translation)

---

### 4.1.3 Create MoveTool Class (Core)
**Priority: MAIN IMPLEMENTATION**

**New Files:**
- `include/ui/MoveTool.h`
- `src/ui/MoveTool.cpp`

**State Machine:**
```
[Inactive] --activate()--> [WaitingForBasePoint]
[WaitingForBasePoint] --click--> [WaitingForDestination]
[WaitingForDestination] --click--> [Commit] --> [Inactive]
[WaitingForDestination] --ESC--> [WaitingForBasePoint]
[WaitingForBasePoint] --ESC--> [Inactive]
```

**Class Structure:**
```cpp
class MoveTool : public Tool {
public:
    MoveTool();

    // Tool interface
    QString name() const override { return QStringLiteral("Move"); }
    QString id() const override { return QStringLiteral("move"); }

    void activate() override;
    void deactivate() override;
    ToolState state() const override;
    QString statusPrompt() const override;

    // Event handlers
    ToolResult handleMousePress(const Point2D& worldPos, QMouseEvent* event) override;
    ToolResult handleMouseMove(const Point2D& worldPos, QMouseEvent* event) override;
    ToolResult handleMouseRelease(const Point2D& worldPos, QMouseEvent* event) override;
    ToolResult handleKeyPress(QKeyEvent* event) override;

    // Rendering
    void render(QPainter& painter, const Viewport& viewport) override;

    // Selection access (set by CADCanvas before activation)
    void setSelectedHandles(const std::vector<std::string>& handles);

private:
    bool commitMove();
    void cancel();

    ToolState state_ = ToolState::Inactive;
    std::optional<Point2D> basePoint_;
    std::optional<Point2D> currentPoint_;
    std::vector<std::string> selectedHandles_;
};
```

**Key Behaviors:**
- **activate()**: Check if selection exists. If empty, show warning and return to selection mode.
- **handleMousePress (base point)**: Store base point, transition to WaitingForDestination
- **handleMouseMove**: Update currentPoint for preview calculation
- **handleMousePress (destination)**: Calculate displacement, commit move
- **render()**: Draw preview of all selected entities at displaced position (ghost overlay)

---

### 4.1.4 MoveTool Preview Rendering
**Priority: MAIN IMPLEMENTATION**

**Render Requirements:**
- Draw all selected entities translated to preview position
- Use dashed lines with reduced opacity (ghost effect)
- Draw displacement vector (line from base point to current point)
- Draw base point marker (small cross/circle)

**Preview Calculation:**
```cpp
void MoveTool::render(QPainter& painter, const Viewport& viewport) {
    if (state_ != ToolState::InProgress || !basePoint_ || !currentPoint_) return;

    double dx = currentPoint_->x() - basePoint_->x();
    double dy = currentPoint_->y() - basePoint_->y();

    // Draw displacement vector
    QPointF screenBase = viewport.worldToScreen(*basePoint_);
    QPointF screenCurrent = viewport.worldToScreen(*currentPoint_);
    painter.setPen(QPen(QColor(100, 100, 255), 1, Qt::DashLine));
    painter.drawLine(screenBase, screenCurrent);

    // Draw preview of each selected entity at new position
    for (const auto& handle : selectedHandles_) {
        auto* entity = documentModel_->findEntityByHandle(handle);
        if (!entity) continue;

        auto translated = GeometryMath::translate(entity->entity, dx, dy);
        renderPreviewEntity(painter, viewport, translated);
    }
}
```

---

### 4.1.5 Integrate MoveTool with ToolManager
**Priority: INTEGRATION**

**Files to Modify:**
- `src/main.cpp` - Register MoveTool with ToolManager

**Registration:**
```cpp
toolManager->registerTool(std::make_unique<MoveTool>());
```

**Menu/Shortcut:**
- Add "Move" to Tools menu
- Shortcut: `M` key (standard CAD shortcut)
- Only enable when selection is non-empty

---

### 4.1.6 Selection Handoff to MoveTool
**Priority: INTEGRATION**

MoveTool needs access to current selection. Options:

**Option A (Recommended): Pass selection at activation**
- CADCanvas calls `moveTool->setSelectedHandles(selectionManager_.selectedHandles())`
- Tool operates on snapshot of selection at activation time

**Option B: Tool has reference to SelectionManager**
- More coupling, but allows dynamic selection updates
- Not needed for Move (selection is fixed during operation)

**Files to Modify:**
- `include/ui/CADCanvas.h` - Add method to activate tool with selection
- `src/ui/CADCanvas.cpp` - Implement selection handoff

---

### 4.1.7 Numeric Input Dialog (Optional Enhancement)
**Priority: ENHANCEMENT**

Allow user to type exact dx, dy values instead of clicking destination.

**Trigger:** Press `Tab` or `Enter` while in WaitingForDestination state

**Dialog:**
```cpp
class MoveInputDialog : public QDialog {
    QDoubleSpinBox* dxSpinBox_;
    QDoubleSpinBox* dySpinBox_;
public:
    std::optional<std::pair<double, double>> getDisplacement();
};
```

**Files:**
- `include/ui/MoveInputDialog.h`
- `src/ui/MoveInputDialog.cpp`

OR use a simpler inline approach with QInputDialog.

---

### 4.1.8 Commit Logic and Validation
**Priority: MAIN IMPLEMENTATION**

**Commit Process:**
```cpp
bool MoveTool::commitMove() {
    if (!basePoint_ || !currentPoint_) return false;

    double dx = currentPoint_->x() - basePoint_->x();
    double dy = currentPoint_->y() - basePoint_->y();

    // Skip if zero displacement
    if (std::abs(dx) < GEOMETRY_EPSILON && std::abs(dy) < GEOMETRY_EPSILON) {
        return false;  // No-op
    }

    for (const auto& handle : selectedHandles_) {
        auto* entity = documentModel_->findEntityByHandle(handle);
        if (!entity) continue;

        auto translated = GeometryMath::translate(entity->entity, dx, dy);

        // Validate translated geometry
        if (!isValidGeometry(translated)) {
            // Log warning, skip this entity
            continue;
        }

        documentModel_->updateEntity(handle, translated);
    }

    return true;
}
```

**Validation:**
- Translated Line2D must still be valid (non-zero length)
- Translated Arc2D must still be valid (positive radius)
- No NaN/Inf coordinates

---

### 4.1.9 Update CMakeLists.txt
**Priority: BUILD**

Add new files to CMakeLists.txt:
```cmake
# In src/ui section
src/ui/MoveTool.cpp

# In include/ui section
include/ui/MoveTool.h
```

---

### 4.1.10 Testing
**Priority: VERIFICATION**

**Manual Tests:**
1. Select single line → Move → Verify coordinates changed correctly
2. Select multiple entities → Move → All move by same displacement
3. Move with snap → Verify snap applies to both base and destination
4. ESC during operation → Verify cancel works, no changes
5. Move with zero displacement → Verify no-op
6. Zoom/pan during move → Verify preview follows correctly

**Edge Cases:**
- Empty selection → Tool should not activate
- Very large displacement → Verify no overflow
- Move entities outside visible viewport → Should still work

---

## Implementation Order

1. **4.1.1** - DocumentModel entity modification (PREREQUISITE)
2. **4.1.2** - Geometry translation functions (PREREQUISITE)
3. **4.1.3** - MoveTool class core structure
4. **4.1.4** - Preview rendering
5. **4.1.9** - CMakeLists.txt update
6. **4.1.5** - ToolManager integration
7. **4.1.6** - Selection handoff
8. **4.1.8** - Commit logic with validation
9. **4.1.10** - Testing
10. **4.1.7** - Numeric input dialog (optional)

---

## Files Summary

### New Files
| File | Purpose |
|------|---------|
| `include/ui/MoveTool.h` | MoveTool class declaration |
| `src/ui/MoveTool.cpp` | MoveTool implementation |
| `include/ui/MoveInputDialog.h` | (Optional) Numeric input dialog |
| `src/ui/MoveInputDialog.cpp` | (Optional) Dialog implementation |

### Modified Files
| File | Changes |
|------|---------|
| `include/model/DocumentModel.h` | Add findEntityByHandle, updateEntity, removeEntity |
| `src/model/DocumentModel.cpp` | Implement entity modification methods |
| `include/geometry/GeometryMath.h` | Add translate() functions |
| `src/geometry/GeometryMath.cpp` | Implement translate() functions |
| `src/main.cpp` | Register MoveTool, add menu item |
| `CMakeLists.txt` | Add new source files |

---

## Architecture Considerations

**Why not modify geometry in-place?**
- Geometry classes are immutable by design (Line2D, Arc2D, etc.)
- Immutability prevents bugs, ensures thread safety
- Transformation creates new validated geometry

**Why snapshot selection at activation?**
- Predictable behavior: what you see selected is what moves
- No surprising changes if selection modified during operation
- Simpler state management

**Future: Undo/Redo Integration (Task 5.x)**
- Move will need to create MoveEntitiesCommand
- Command stores: handles, original positions, displacement
- Undo restores original positions
- This is NOT implemented in 4.1 (separate task)

---

## Status Bar Prompts

| State | Prompt |
|-------|--------|
| WaitingForBasePoint | "MOVE: Click base point (or ESC to cancel)" |
| WaitingForDestination | "MOVE: Click destination point (or Tab for coordinates)" |

---

## Ready for Implementation

This guide provides a complete breakdown of Task 4.1.
Start with **4.1.1 (DocumentModel)** and **4.1.2 (GeometryMath)** as prerequisites.

Would you like to proceed with implementation?
