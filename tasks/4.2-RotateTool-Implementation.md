# Task 4.2 - Rotate Tool Implementation Guide

## Overview

The Rotate Tool allows users to rotate selected entities around a center point by a specified angle.

**Current Status:** Mostly complete. Only numeric angle input remains.

**Workflow:**
1. User selects entities (using existing selection system)
2. User activates Rotate Tool (R key)
3. User clicks rotation center
4. User moves mouse → preview shows rotated entities
5. User clicks to set angle (Shift for 15° snap) **OR types angle value** ← NOT YET IMPLEMENTED
6. Tool deactivates after commit

---

## Implementation Status

### Already Implemented (COMPLETE)

| Feature | Status | Location |
|---------|--------|----------|
| RotateTool class | ✅ | `include/ui/RotateTool.h`, `src/ui/RotateTool.cpp` |
| Selection check on activate | ✅ | `RotateTool.cpp:24-35` |
| Click rotation center | ✅ | `RotateTool.cpp:66-74` |
| Preview rotation on mouse move | ✅ | `RotateTool.cpp:161-234` |
| Angle snap (Shift + 15° increments) | ✅ | `RotateTool.cpp:97-98, 138-159` |
| Preview rendering (all entity types) | ✅ | `RotateTool.cpp:236-316` |
| Commit rotation | ✅ | `RotateTool.cpp:318-385` |
| ESC to cancel | ✅ | `RotateTool.cpp:119-136` |
| Arc direction preservation | ✅ | Uses `GeometryMath::rotate()` which preserves direction |
| Angle display during preview | ✅ | `RotateTool.cpp:216-223` |
| Center point marker | ✅ | `RotateTool.cpp:170-186` |

### Not Implemented (REMAINING WORK)

| Feature | Status | Description |
|---------|--------|-------------|
| Numeric angle input | ❌ | Type exact angle value instead of clicking |

---

## Remaining Subtask: Numeric Angle Input

### 4.2.1 Add Numeric Angle Input Dialog
**Priority: ENHANCEMENT**

Allow user to type exact rotation angle instead of clicking destination.

**Trigger Options:**
- Press `Tab` or `Enter` while in InProgress state (WaitingForAngle)
- This matches the MoveTool pattern (4.1.7)

**Dialog Requirements:**
- Single input: Rotation angle in degrees
- Range: -360° to +360° (or unlimited with modulo)
- Precision: 0.01° (enough for most CAD use cases)
- Positive = CCW, Negative = CW (standard math convention)

---

### 4.2.1.1 Create RotateInputDialog Class

**New Files:**
- `include/ui/RotateInputDialog.h`
- `src/ui/RotateInputDialog.cpp`

**Class Structure:**
```cpp
#pragma once

#include <QDialog>
#include <QDoubleSpinBox>
#include <optional>

namespace OwnCAD {
namespace UI {

/**
 * @brief Dialog for entering exact rotation angle
 *
 * Allows user to type a specific angle value in degrees.
 * Positive = Counter-clockwise (CCW)
 * Negative = Clockwise (CW)
 */
class RotateInputDialog : public QDialog {
    Q_OBJECT

public:
    explicit RotateInputDialog(QWidget* parent = nullptr);
    ~RotateInputDialog() override = default;

    /**
     * @brief Get the entered angle in degrees
     * @return Angle if user confirmed, std::nullopt if cancelled
     */
    std::optional<double> getAngleDegrees() const;

    /**
     * @brief Set initial angle value (for showing current preview angle)
     * @param angleDegrees Angle in degrees
     */
    void setInitialAngle(double angleDegrees);

private:
    void setupUI();

    QDoubleSpinBox* angleSpinBox_ = nullptr;
    bool accepted_ = false;
};

} // namespace UI
} // namespace OwnCAD
```

**Implementation (RotateInputDialog.cpp):**
```cpp
#include "ui/RotateInputDialog.h"
#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QLabel>
#include <QPushButton>
#include <QDialogButtonBox>

namespace OwnCAD {
namespace UI {

RotateInputDialog::RotateInputDialog(QWidget* parent)
    : QDialog(parent)
{
    setWindowTitle(tr("Enter Rotation Angle"));
    setModal(true);
    setFixedSize(280, 120);
    setupUI();
}

void RotateInputDialog::setupUI() {
    auto* mainLayout = new QVBoxLayout(this);

    // Angle input row
    auto* inputLayout = new QHBoxLayout();
    auto* label = new QLabel(tr("Angle (degrees):"), this);

    angleSpinBox_ = new QDoubleSpinBox(this);
    angleSpinBox_->setRange(-3600.0, 3600.0);  // Allow multiple rotations
    angleSpinBox_->setDecimals(2);
    angleSpinBox_->setSuffix(QStringLiteral("\u00B0"));  // Degree symbol
    angleSpinBox_->setValue(0.0);
    angleSpinBox_->setButtonSymbols(QAbstractSpinBox::PlusMinus);
    angleSpinBox_->selectAll();  // Select all text for easy overwrite

    inputLayout->addWidget(label);
    inputLayout->addWidget(angleSpinBox_);
    mainLayout->addLayout(inputLayout);

    // Info label
    auto* infoLabel = new QLabel(
        tr("Positive = CCW, Negative = CW"),
        this
    );
    infoLabel->setStyleSheet("color: gray; font-size: 10px;");
    mainLayout->addWidget(infoLabel);

    // Buttons
    auto* buttonBox = new QDialogButtonBox(
        QDialogButtonBox::Ok | QDialogButtonBox::Cancel,
        this
    );
    connect(buttonBox, &QDialogButtonBox::accepted, this, [this]() {
        accepted_ = true;
        accept();
    });
    connect(buttonBox, &QDialogButtonBox::rejected, this, &QDialog::reject);
    mainLayout->addWidget(buttonBox);

    // Focus on spinbox
    angleSpinBox_->setFocus();
}

std::optional<double> RotateInputDialog::getAngleDegrees() const {
    if (accepted_) {
        return angleSpinBox_->value();
    }
    return std::nullopt;
}

void RotateInputDialog::setInitialAngle(double angleDegrees) {
    angleSpinBox_->setValue(angleDegrees);
    angleSpinBox_->selectAll();
}

} // namespace UI
} // namespace OwnCAD
```

---

### 4.2.1.2 Integrate Dialog with RotateTool

**File to Modify:** `src/ui/RotateTool.cpp`

**Changes Required:**

1. **Add include:**
```cpp
#include "ui/RotateInputDialog.h"
```

2. **Modify handleKeyPress() to trigger dialog:**
```cpp
ToolResult RotateTool::handleKeyPress(QKeyEvent* event) {
    if (event->key() == Qt::Key_Escape) {
        // ... existing ESC handling ...
    }

    // NEW: Tab or Enter triggers numeric input
    if (state_ == ToolState::InProgress &&
        (event->key() == Qt::Key_Tab || event->key() == Qt::Key_Return)) {

        // Show numeric input dialog
        RotateInputDialog dialog;

        // Pre-fill with current preview angle
        double currentAngle = calculateAngle(angleSnapEnabled_);
        double currentDegrees = currentAngle * 180.0 / PI;
        dialog.setInitialAngle(currentDegrees);

        if (dialog.exec() == QDialog::Accepted) {
            auto angleDegrees = dialog.getAngleDegrees();
            if (angleDegrees) {
                // Commit with typed angle
                numericAngle_ = *angleDegrees * PI / 180.0;  // Convert to radians
                if (commitRotationWithAngle(numericAngle_)) {
                    cancel();
                    return ToolResult::Completed;
                }
            }
        }
        return ToolResult::Continue;  // Dialog cancelled or failed
    }

    return ToolResult::Ignored;
}
```

3. **Add helper method for numeric commit:**
```cpp
bool RotateTool::commitRotationWithAngle(double angleRadians) {
    if (!centerPoint_ || !documentModel_) {
        qWarning() << "RotateTool: Cannot commit - missing data";
        return false;
    }

    // Skip if zero rotation
    if (std::abs(angleRadians) < GEOMETRY_EPSILON) {
        qDebug() << "RotateTool: Zero rotation - no-op";
        return false;
    }

    int successCount = 0;
    int failCount = 0;

    for (const auto& handle : selectedHandles_) {
        auto* entityMeta = documentModel_->findEntityByHandle(handle);
        if (!entityMeta) {
            failCount++;
            continue;
        }

        bool updated = std::visit([&](auto&& entity) -> bool {
            using T = std::decay_t<decltype(entity)>;

            if constexpr (std::is_same_v<T, Line2D>) {
                auto rotated = GeometryMath::rotate(entity, *centerPoint_, angleRadians);
                if (rotated && rotated->isValid()) {
                    return documentModel_->updateEntity(handle, *rotated);
                }
                return false;
            }
            else if constexpr (std::is_same_v<T, Arc2D>) {
                auto rotated = GeometryMath::rotate(entity, *centerPoint_, angleRadians);
                if (rotated && rotated->isValid()) {
                    return documentModel_->updateEntity(handle, *rotated);
                }
                return false;
            }
            else if constexpr (std::is_same_v<T, Ellipse2D>) {
                auto rotated = GeometryMath::rotate(entity, *centerPoint_, angleRadians);
                if (rotated && rotated->isValid()) {
                    return documentModel_->updateEntity(handle, *rotated);
                }
                return false;
            }
            else if constexpr (std::is_same_v<T, Point2D>) {
                Point2D rotated = GeometryMath::rotate(entity, *centerPoint_, angleRadians);
                return documentModel_->updateEntity(handle, rotated);
            }
            return false;
        }, entityMeta->entity);

        if (updated) {
            successCount++;
        } else {
            failCount++;
        }
    }

    double angleDegrees = angleRadians * 180.0 / PI;
    qDebug() << "RotateTool: Rotated" << successCount << "entities by"
             << angleDegrees << "degrees," << failCount << "failed";
    return successCount > 0;
}
```

---

### 4.2.1.3 Update RotateTool Header

**File to Modify:** `include/ui/RotateTool.h`

**Add declaration:**
```cpp
private:
    // ... existing members ...

    /**
     * @brief Commit rotation with specified angle (for numeric input)
     * @param angleRadians Rotation angle in radians
     * @return true if rotation was successful
     */
    bool commitRotationWithAngle(double angleRadians);
```

---

### 4.2.1.4 Update Status Prompt

**File to Modify:** `src/ui/RotateTool.cpp`

Update `statusPrompt()` to mention numeric input option:

```cpp
QString RotateTool::statusPrompt() const {
    switch (state_) {
        case ToolState::Inactive:
            return QString();
        case ToolState::WaitingForInput:
            return QStringLiteral("ROTATE: Click rotation center (or ESC to cancel)");
        case ToolState::InProgress:
            if (angleSnapEnabled_) {
                return QStringLiteral("ROTATE: Click to set angle (Snap: 15\u00B0) - Tab for exact angle");
            }
            return QStringLiteral("ROTATE: Click to set angle (Shift=snap, Tab=exact angle)");
    }
    return QString();
}
```

---

### 4.2.1.5 Update CMakeLists.txt

**File to Modify:** `CMakeLists.txt`

Add new dialog files:
```cmake
# In src/ui section
src/ui/RotateInputDialog.cpp

# In include/ui section
include/ui/RotateInputDialog.h
```

---

### 4.2.1.6 Update File-Structure.md

**File to Modify:** `File-Structure.md`

Add entry under UI section:
```markdown
- `RotateInputDialog.h/cpp`: Dialog for entering exact rotation angle in degrees.
```

---

## Implementation Order

1. **4.2.1.1** - Create RotateInputDialog class (new files)
2. **4.2.1.5** - Update CMakeLists.txt
3. **4.2.1.3** - Update RotateTool.h (add method declaration)
4. **4.2.1.2** - Integrate dialog with RotateTool.cpp
5. **4.2.1.4** - Update status prompt
6. **4.2.1.6** - Update File-Structure.md

---

## Files Summary

### New Files
| File | Purpose |
|------|---------|
| `include/ui/RotateInputDialog.h` | Dialog class declaration |
| `src/ui/RotateInputDialog.cpp` | Dialog implementation |

### Modified Files
| File | Changes |
|------|---------|
| `include/ui/RotateTool.h` | Add `commitRotationWithAngle()` declaration |
| `src/ui/RotateTool.cpp` | Add Tab/Enter handling, numeric commit, update prompt |
| `CMakeLists.txt` | Add new dialog source files |
| `File-Structure.md` | Document new dialog class |

---

## Testing Checklist

### Manual Tests
1. Activate Rotate → Press Tab → Dialog appears with 0° angle
2. Type 45 → OK → Entities rotate exactly 45° CCW
3. Type -90 → OK → Entities rotate exactly 90° CW
4. Type 0 → OK → No change (no-op)
5. Type 360 → OK → Entities return to original position
6. Press Tab → Cancel dialog → No rotation, tool stays active
7. Move mouse to 30° → Press Tab → Dialog shows ~30° → Modify to 45° → OK → 45° rotation

### Edge Cases
- Very small angles (0.01°) → Should work
- Large angles (720°) → Should work (multiple rotations)
- Negative angles → Should work (CW rotation)
- Enter key also opens dialog (not just Tab)

---

## Status Bar Prompts

| State | Current Prompt | Updated Prompt |
|-------|----------------|----------------|
| WaitingForInput | "ROTATE: Click rotation center" | "ROTATE: Click rotation center (or ESC to cancel)" |
| InProgress (no snap) | "ROTATE: Click to set angle (Hold Shift for 15° snap)" | "ROTATE: Click to set angle (Shift=snap, Tab=exact angle)" |
| InProgress (snap) | "ROTATE: Click to set angle (Snap: 15°) - Release Shift for free rotation" | "ROTATE: Click to set angle (Snap: 15°) - Tab for exact angle" |

---

## Architecture Notes

### Why Separate Dialog Class?
- Follows existing pattern (GridSettingsDialog)
- Reusable for other angle input scenarios
- Keeps RotateTool focused on rotation logic
- Easier to test and maintain

### Why Refactor commitRotation()?
- Current `commitRotation()` calculates angle from mouse position
- Numeric input needs to commit with user-typed angle
- `commitRotationWithAngle(double)` accepts any angle, used by both:
  - Click-to-set-angle (via `calculateAngle()`)
  - Numeric input (via dialog result)

**Alternative (simpler but less clean):**
- Keep single `commitRotation()` but add optional angle override parameter
- Less code but conflates mouse-based and numeric input paths

---

## Ready for Implementation

This guide details the remaining work for Task 4.2.

**Estimated scope:** ~150-200 lines of new code across 4 files.

Would you like to proceed with implementation?
